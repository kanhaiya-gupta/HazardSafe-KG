<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document to Knowledge Graph Pipeline - HazardSafe-KG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', path='/css/main.css') }}" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        .pipeline-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            border-radius: 0 0 10px 10px;
        }
        
        .pipeline-header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .pipeline-header .lead {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .pipeline-step {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .pipeline-step.active {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .pipeline-step.completed {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .pipeline-step.failed {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .step-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .step-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 12px;
            color: #6c757d;
        }
        
        .result-card {
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .result-card.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        
        .result-card.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .result-card.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .metric-card {
            text-align: center;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .feature-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .feature-card .card-header {
            background: #f8f9fa;
            color: #2c3e50;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
        }
        
        .feature-card .card-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .btn-custom {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #bdc3c7;
            padding: 10px 12px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
        }
        
        .form-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        
        .text-muted {
            color: #7f8c8d !important;
        }
        
        .container {
            max-width: 1400px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .file-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            font-family: monospace;
            font-size: 12px;
        }
        
        .data-preview-table {
            font-size: 12px;
        }
        
        .data-preview-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt me-2"></i>
                HazardSafe-KG
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/ontology">Ontology</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/kg">Knowledge Graph</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/nlp_rag">NLP & RAG System</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/validation">Validation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/quality">Quality</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/system-flowchart">Architecture</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="pipeline-header">
        <div class="container text-center">
            <h1><i class="fas fa-file-alt me-3"></i>Document to Knowledge Graph Pipeline</h1>
            <p class="lead">Transform CSV, Excel, and JSON documents into structured knowledge graph entities and relationships</p>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Pipeline Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>Pipeline Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 text-center">
                                <div class="pipeline-step active" id="step1">
                                    <div class="step-number">1</div>
                                    <div class="step-title">Document Upload</div>
                                    <div class="step-desc">CSV, Excel, JSON</div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="pipeline-step" id="step2">
                                    <div class="step-number">2</div>
                                    <div class="step-title">Data Parsing</div>
                                    <div class="step-desc">Extract & Validate</div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="pipeline-step" id="step3">
                                    <div class="step-number">3</div>
                                    <div class="step-title">Entity Extraction</div>
                                    <div class="step-desc">Identify Entities</div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="pipeline-step" id="step4">
                                    <div class="step-number">4</div>
                                    <div class="step-title">Relationship Mapping</div>
                                    <div class="step-desc">Map Relations</div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="pipeline-step" id="step5">
                                    <div class="step-number">5</div>
                                    <div class="step-title">KG Storage</div>
                                    <div class="step-desc">Neo4j Graph</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Upload -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload me-2"></i>Document Upload</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Supported Formats</label>
                                    <div class="d-flex gap-2 mb-3">
                                        <span class="badge bg-success">CSV</span>
                                        <span class="badge bg-info">Excel (.xlsx, .xls)</span>
                                        <span class="badge bg-warning">JSON</span>
                                    </div>
                                    
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h5>Drag & Drop Files Here</h5>
                                        <p class="text-muted">or click to browse</p>
                                        <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls,.json" style="display: none;">
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-primary btn-custom" id="uploadFiles">
                                            <i class="fas fa-upload me-2"></i>Upload Files
                                        </button>
                                        <button class="btn btn-secondary btn-custom" id="clearFiles">
                                            <i class="fas fa-trash me-2"></i>Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Uploaded Files</label>
                                    <div id="fileList" class="mb-3">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-file-alt fa-2x mb-2"></i>
                                            <p>No files uploaded yet</p>
                                        </div>
                                    </div>
                                    
                                    <div id="filePreview" style="display: none;">
                                        <label class="form-label">File Preview</label>
                                        <div class="file-preview" id="previewContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Configuration -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>Pipeline Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="entityDetection" class="form-label">Entity Detection Method</label>
                                    <select class="form-select" id="entityDetection">
                                        <option value="auto">Auto-detect</option>
                                        <option value="column_mapping">Column Mapping</option>
                                        <option value="nlp_extraction">NLP Extraction</option>
                                        <option value="rule_based">Rule-based</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="relationshipMapping" class="form-label">Relationship Mapping</label>
                                    <select class="form-select" id="relationshipMapping">
                                        <option value="auto">Auto-detect</option>
                                        <option value="foreign_key">Foreign Key Detection</option>
                                        <option value="semantic">Semantic Analysis</option>
                                        <option value="custom">Custom Mapping</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dataValidation" class="form-label">Data Validation Level</label>
                                    <select class="form-select" id="dataValidation">
                                        <option value="basic">Basic</option>
                                        <option value="standard">Standard</option>
                                        <option value="strict">Strict</option>
                                        <option value="custom">Custom Rules</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="outputFormat" class="form-label">Output Format</label>
                                    <select class="form-select" id="outputFormat">
                                        <option value="neo4j">Neo4j Graph</option>
                                        <option value="cypher">Cypher Scripts</option>
                                        <option value="rdf">RDF Triples</option>
                                        <option value="json">JSON-LD</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Actions</label>
                                    <div class="d-grid gap-2 d-md-block">
                                        <button class="btn btn-primary btn-custom" id="runPipeline">
                                            <i class="fas fa-play me-2"></i>Run Pipeline
                                        </button>
                                        <button class="btn btn-info btn-custom" id="previewData">
                                            <i class="fas fa-eye me-2"></i>Preview Data
                                        </button>
                                        <button class="btn btn-secondary btn-custom" id="checkStatus">
                                            <i class="fas fa-info me-2"></i>Check Status
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>Pipeline Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="pipelineStatus">
                            <div class="text-center text-muted">
                                <i class="fas fa-hourglass-half fa-3x mb-3"></i>
                                <p>Upload files and click "Check Status" to view current pipeline status</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Results -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>Pipeline Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="pipelineResults">
                            <div class="text-center text-muted">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <p>Run the pipeline to see detailed results</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Details -->
        <div class="row">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Step Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="stepDetails">
                            <!-- Step 1 Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="step1Header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1Details">
                                        <strong>Step 1: Document Upload & Validation</strong>
                                    </button>
                                </h2>
                                <div id="step1Details" class="accordion-collapse collapse show" data-bs-parent="#stepDetails">
                                    <div class="accordion-body">
                                        <p><strong>Purpose:</strong> Upload and validate CSV, Excel, and JSON documents</p>
                                        <p><strong>Input:</strong> CSV, Excel (.xlsx, .xls), JSON files</p>
                                        <p><strong>Output:</strong> Validated document objects with metadata</p>
                                        <div id="step1Results" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2 Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="step2Header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2Details">
                                        <strong>Step 2: Data Parsing & Structure Analysis</strong>
                                    </button>
                                </h2>
                                <div id="step2Details" class="accordion-collapse collapse" data-bs-parent="#stepDetails">
                                    <div class="accordion-body">
                                        <p><strong>Purpose:</strong> Parse data and analyze structure for entity/relationship identification</p>
                                        <p><strong>Input:</strong> Validated documents from Step 1</p>
                                        <p><strong>Output:</strong> Structured data with schema analysis</p>
                                        <div id="step2Results" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3 Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="step3Header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3Details">
                                        <strong>Step 3: Entity Extraction & Classification</strong>
                                    </button>
                                </h2>
                                <div id="step3Details" class="accordion-collapse collapse" data-bs-parent="#stepDetails">
                                    <div class="accordion-body">
                                        <p><strong>Purpose:</strong> Extract and classify entities from structured data</p>
                                        <p><strong>Input:</strong> Parsed data from Step 2</p>
                                        <p><strong>Output:</strong> Identified entities with properties and types</p>
                                        <div id="step3Results" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 4 Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="step4Header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4Details">
                                        <strong>Step 4: Relationship Mapping & Validation</strong>
                                    </button>
                                </h2>
                                <div id="step4Details" class="accordion-collapse collapse" data-bs-parent="#stepDetails">
                                    <div class="accordion-body">
                                        <p><strong>Purpose:</strong> Map relationships between entities and validate consistency</p>
                                        <p><strong>Input:</strong> Extracted entities from Step 3</p>
                                        <p><strong>Output:</strong> Validated relationships with properties</p>
                                        <div id="step4Results" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 5 Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="step5Header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step5Details">
                                        <strong>Step 5: Knowledge Graph Storage</strong>
                                    </button>
                                </h2>
                                <div id="step5Details" class="accordion-collapse collapse" data-bs-parent="#stepDetails">
                                    <div class="accordion-body">
                                        <p><strong>Purpose:</strong> Store entities and relationships in Neo4j knowledge graph</p>
                                        <p><strong>Input:</strong> Validated entities and relationships from Step 4</p>
                                        <p><strong>Output:</strong> Knowledge graph in Neo4j database</p>
                                        <div id="step5Results" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="loadingMessage">Processing...</h5>
                    <p id="loadingDetails" class="text-muted">Please wait while the pipeline is running</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const filePreview = document.getElementById('filePreview');
        const previewContent = document.getElementById('previewContent');
        const uploadFilesBtn = document.getElementById('uploadFiles');
        const clearFilesBtn = document.getElementById('clearFiles');
        const runPipelineBtn = document.getElementById('runPipeline');
        const previewDataBtn = document.getElementById('previewData');
        const checkStatusBtn = document.getElementById('checkStatus');
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        
        let uploadedFiles = [];
        
        // File upload handling
        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
        
        function handleFiles(files) {
            const validFiles = files.filter(file => {
                const validTypes = ['.csv', '.xlsx', '.xls', '.json'];
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                return validTypes.includes(extension);
            });
            
            uploadedFiles = [...uploadedFiles, ...validFiles];
            updateFileList();
        }
        
        function updateFileList() {
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p>No files uploaded yet</p>
                    </div>
                `;
                filePreview.style.display = 'none';
                return;
            }
            
            let html = '<div class="list-group">';
            uploadedFiles.forEach((file, index) => {
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                let icon = 'fa-file-alt';
                let badgeClass = 'bg-secondary';
                
                if (extension === '.csv') {
                    icon = 'fa-file-csv';
                    badgeClass = 'bg-success';
                } else if (extension === '.xlsx' || extension === '.xls') {
                    icon = 'fa-file-excel';
                    badgeClass = 'bg-info';
                } else if (extension === '.json') {
                    icon = 'fa-file-code';
                    badgeClass = 'bg-warning';
                }
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${icon} me-2"></i>
                            ${file.name}
                            <small class="text-muted ms-2">(${(file.size / 1024).toFixed(1)} KB)</small>
                        </div>
                        <div>
                            <span class="badge ${badgeClass} rounded-pill me-2">${extension}</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="previewFile(${index})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            fileList.innerHTML = html;
        }
        
        // Global functions for file operations
        window.previewFile = function(index) {
            const file = uploadedFiles[index];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                let preview = '';
                
                if (file.name.endsWith('.csv')) {
                    const lines = content.split('\n').slice(0, 10);
                    preview = lines.map(line => line.replace(/,/g, ' | ')).join('\n');
                } else if (file.name.endsWith('.json')) {
                    try {
                        const json = JSON.parse(content);
                        preview = JSON.stringify(json, null, 2).substring(0, 1000) + '...';
                    } catch (e) {
                        preview = 'Invalid JSON format';
                    }
                } else {
                    preview = 'Excel file preview not available';
                }
                
                previewContent.textContent = preview;
                filePreview.style.display = 'block';
            };
            
            reader.readAsText(file);
        };
        
        window.removeFile = function(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        };
        
        // Clear all files
        clearFilesBtn.addEventListener('click', () => {
            uploadedFiles = [];
            updateFileList();
        });
        
        // Upload files
        uploadFilesBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            showLoading('Uploading Files', 'Processing document uploads...');
            
            const formData = new FormData();
            uploadedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            try {
                const response = await fetch('/nlp_rag/pipeline/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showSuccess('Files uploaded successfully', `${result.files_uploaded} files processed`);
                } else {
                    showError('Upload failed', result.message);
                }
            } catch (error) {
                hideLoading();
                showError('Network error', error.message);
            }
        });
        
        // Run pipeline
        runPipelineBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                alert('Please upload files first');
                return;
            }
            
            const config = {
                entity_detection: document.getElementById('entityDetection').value,
                relationship_mapping: document.getElementById('relationshipMapping').value,
                data_validation: document.getElementById('dataValidation').value,
                output_format: document.getElementById('outputFormat').value
            };
            
            showLoading('Running Document-to-KG Pipeline', 'This may take several minutes...');
            
            try {
                const response = await fetch('/nlp_rag/pipeline/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showPipelineResults(result.results);
                    updatePipelineSteps(result.results);
                } else {
                    showError('Pipeline execution failed', result.message);
                }
            } catch (error) {
                hideLoading();
                showError('Network error', error.message);
            }
        });
        
        // Preview data
        previewDataBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                alert('Please upload files first');
                return;
            }
            
            showLoading('Analyzing Data', 'Extracting data structure and preview...');
            
            try {
                const response = await fetch('/nlp_rag/pipeline/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        files: uploadedFiles.map(f => f.name)
                    })
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showDataPreview(result.preview);
                } else {
                    showError('Preview failed', result.message);
                }
            } catch (error) {
                hideLoading();
                showError('Network error', error.message);
            }
        });
        
        // Check pipeline status
        checkStatusBtn.addEventListener('click', async () => {
            showLoading('Checking Pipeline Status', 'Verifying system readiness...');
            
            try {
                const response = await fetch('/nlp_rag/pipeline/status');
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showPipelineStatus(result.pipeline_status);
                } else {
                    showError('Status check failed', result.message);
                }
            } catch (error) {
                hideLoading();
                showError('Network error', error.message);
            }
        });
        
        function showLoading(message, details) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingDetails').textContent = details;
            loadingModal.show();
        }
        
        function hideLoading() {
            loadingModal.hide();
        }
        
        function showPipelineResults(results) {
            const resultsDiv = document.getElementById('pipelineResults');
            
            let html = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${results.total_entities_created || 0}</div>
                            <div class="metric-label">Entities Created</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${results.total_relationships_created || 0}</div>
                            <div class="metric-label">Relationships Created</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${(results.quality_score * 100).toFixed(1)}%</div>
                            <div class="metric-label">Quality Score</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${results.overall_success ? 'Success' : 'Failed'}</div>
                            <div class="metric-label">Overall Status</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (results.errors && results.errors.length > 0) {
                html += `
                    <div class="alert alert-danger mt-3">
                        <h6>Errors:</h6>
                        <ul>
                            ${results.errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function showDataPreview(preview) {
            const resultsDiv = document.getElementById('pipelineResults');
            
            let html = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value">${preview.files_analyzed || 0}</div>
                            <div class="metric-label">Files Analyzed</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value">${preview.potential_entities || 0}</div>
                            <div class="metric-label">Potential Entities</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="metric-card">
                            <div class="metric-value">${preview.potential_relationships || 0}</div>
                            <div class="metric-label">Potential Relationships</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (preview.sample_data) {
                html += `
                    <div class="mt-3">
                        <h6>Sample Data Structure:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm data-preview-table">
                                <thead>
                                    <tr>
                                        ${Object.keys(preview.sample_data[0] || {}).map(key => `<th>${key}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${preview.sample_data.slice(0, 5).map(row => 
                                        `<tr>${Object.values(row).map(val => `<td>${val}</td>`).join('')}</tr>`
                                    ).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function showPipelineStatus(status) {
            const statusDiv = document.getElementById('pipelineStatus');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Uploaded Files</h6>
                        <p><strong>Count:</strong> ${status.files_count}</p>
                        <p><strong>Ready:</strong> ${status.pipeline_ready ? 'Yes' : 'No'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Neo4j Connection</h6>
                        <p><strong>Status:</strong> ${status.neo4j_connected ? 'Connected' : 'Disconnected'}</p>
                    </div>
                </div>
            `;
            
            if (status.files && status.files.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>Uploaded Files:</h6>
                        <ul class="list-group">
                            ${status.files.map(file => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${file.name}
                                    <span class="badge bg-primary rounded-pill">${file.type}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = html;
        }
        
        function updatePipelineSteps(results) {
            // Reset all steps
            document.querySelectorAll('.pipeline-step').forEach(step => {
                step.classList.remove('active', 'completed', 'failed');
            });
            
            // Update based on results
            if (results.step1_upload.success) {
                document.getElementById('step1').classList.add('completed');
                showStepResults('step1Results', results.step1_upload);
            }
            
            if (results.step2_parsing.success) {
                document.getElementById('step2').classList.add('completed');
                showStepResults('step2Results', results.step2_parsing);
            }
            
            if (results.step3_entities.success) {
                document.getElementById('step3').classList.add('completed');
                showStepResults('step3Results', results.step3_entities);
            }
            
            if (results.step4_relationships.success) {
                document.getElementById('step4').classList.add('completed');
                showStepResults('step4Results', results.step4_relationships);
            }
            
            if (results.step5_storage.success) {
                document.getElementById('step5').classList.add('completed');
                showStepResults('step5Results', results.step5_storage);
            }
        }
        
        function showStepResults(elementId, results) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let html = `
                <div class="result-card ${results.success ? 'success' : 'error'}">
                    <h6>${results.success ? 'Success' : 'Failed'}</h6>
                    <p><strong>Files:</strong> ${results.files_processed || 0}</p>
                    <p><strong>Records:</strong> ${results.records_processed || 0}</p>
            `;
            
            if (results.errors && results.errors.length > 0) {
                html += `
                    <div class="alert alert-warning mt-2">
                        <small>${results.errors.join(', ')}</small>
                    </div>
                `;
            }
            
            html += '</div>';
            element.innerHTML = html;
        }
        
        function showSuccess(title, message) {
            const resultsDiv = document.getElementById('pipelineResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>${title}</h6>
                    <p>${message}</p>
                </div>
            `;
        }
        
        function showError(title, message) {
            const resultsDiv = document.getElementById('pipelineResults');
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>${title}</h6>
                    <p>${message}</p>
                </div>
            `;
        }
    });
    </script>
</body>
</html> 